<video id="preview" width="300" height="200"></video>
<table id="attendanceTable">
  <tr>
    <th>الرقم المدني</th>
    <th>الاسم</th>
    <th>الصف</th>
    <th>الفصل</th>
    <th>الوقت</th>
    <th>التاريخ</th>
  </tr>
</table>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
const attendance = JSON.parse(localStorage.getItem("attendance") || "[]");
const table = document.getElementById("attendanceTable");

function addToTable(student) {
    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${student.id}</td>
        <td>${student.name}</td>
        <td>${student.grade}</td>
        <td>${student.class}</td>
        <td>${student.time}</td>
        <td>${student.date}</td>
    `;
    table.appendChild(row);
}

const html5QrCode = new Html5Qrcode("preview");

function onScanSuccess(decodedText, decodedResult) {
    // مثال: الطلاب مخزن في localStorage باسم "students"
    const students = JSON.parse(localStorage.getItem("students") || "[]");
    const student = students.find(s => s.id === decodedText);

    if(!student){
        alert("الطالب غير موجود في النظام");
        return;
    }

    // تسجيل الحضور
    const now = new Date();
    const record = {
        ...student,
        time: now.toLocaleTimeString(),
        date: now.toLocaleDateString()
    };
    attendance.push(record);
    localStorage.setItem("attendance", JSON.stringify(attendance));
    
    addToTable(record); // تحديث الجدول مباشرة
    
    // لا تعيد تحميل الصفحة، لا توقف الكاميرا
}

function onScanFailure(error) {
    // يمكن تجاهل الأخطاء الصغيرة
}

// بدء تشغيل الكاميرا
Html5Qrcode.getCameras().then(cameras => {
    if(cameras && cameras.length) {
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            onScanFailure
        );
    } else {
        alert("لم يتم العثور على كاميرا");
    }
}).catch(err => {
    console.error(err);
});
</script>
