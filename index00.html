<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨ - ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body {
  font-family: "Tajawal", sans-serif;
  background: #f3f6f4;
  direction: rtl;
}
.moe-green { color:#017c67; }
.moe-btn { background:#017c67; color:#fff; }
.moe-btn:hover { background:#026f5d; }
.moe-card {
  background:#fff;
  border-radius:16px;
  border:1px solid #d9e3df;
  padding:20px;
}

/* ===== iPhone Fullscreen Camera FIX ===== */
#reader {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  background: #000;
  z-index: 100;
  display: none;
}
</style>
</head>

<body>

<!-- ğŸ”Š ØµÙˆØª Beep -->
<audio id="beepSound" preload="auto">
  <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
</audio>

<div class="max-w-6xl mx-auto p-4 md:p-6">
<div class="moe-card shadow-md">

<!-- HEADER -->
<div class="flex justify-between items-center mb-6">
  <div>
    <h1 class="text-3xl font-bold moe-green">Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
    <p class="text-gray-500 text-sm">QR + Excel + SMS</p>
  </div>
  <div class="text-sm">
    <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> <span id="todayLabel"></span></div>
    <div id="smsBalance" class="text-xs text-green-700 mt-1">...</div>
  </div>
</div>

<!-- TABS -->
<div class="grid grid-cols-2 md:grid-cols-6 gap-2 mb-6">
  <button class="tab-btn moe-btn py-2 rounded" data-target="scan">Ù…Ø³Ø­ QR</button>
  <button class="tab-btn bg-gray-200 py-2 rounded" data-target="excel">Excel</button>
  <button class="tab-btn bg-gray-200 py-2 rounded" data-target="attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
</div>

<!-- SCAN -->
<div id="scan" class="section">
  <div id="reader"></div>
  <p id="scanMessage" class="text-center font-bold mt-4"></p>
</div>

<!-- EXCEL -->
<div id="excel" class="section hidden">
  <input id="excelFile" type="file" accept=".xls,.xlsx" class="border p-2" />
  <button id="btnImportExcel" class="moe-btn px-4 py-2 rounded">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
  <div id="excelStatus" class="mt-3"></div>
  <div id="studentsContainer"></div>
</div>

<!-- ATTENDANCE -->
<div id="attendance" class="section hidden">
  <table class="w-full text-sm border mt-4" id="attendanceTable">
    <thead class="bg-green-700 text-white">
      <tr>
        <th>ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</div>
</div>

<script>
/* ================== Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù…Ø© ================== */
let students = [];
let attendance = [];
let scanner = null;
const beep = document.getElementById("beepSound");

document.getElementById("todayLabel").textContent =
  new Date().toLocaleDateString("ar-SA");

/* ================== Tabs ================== */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".section").forEach(s=>s.classList.add("hidden"));
    document.getElementById(btn.dataset.target).classList.remove("hidden");

    if(btn.dataset.target==="scan"){
      setTimeout(startScanner,300);
    } else {
      stopScanner();
    }
  }
});

/* ================== QR Scanner ================== */
function startScanner(){
  stopScanner();
  const reader = document.getElementById("reader");
  reader.style.display="block";

  scanner = new Html5Qrcode("reader");

  scanner.start(
    { facingMode:{ exact:"environment" } },
    { fps:10, qrbox:300 },
    (text)=>{
      beep.play().catch(()=>{});
      stopScanner();
      handleQR(text);
    },
    ()=>{}
  ).catch(()=>{
    alert("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©");
  });
}

function stopScanner(){
  if(scanner){
    try{ scanner.stop(); }catch(e){}
    scanner=null;
  }
  document.getElementById("reader").style.display="none";
}

/* ================== QR Result ================== */
function handleQR(text){
  document.getElementById("scanMessage").textContent="ØªÙ… Ø§Ù„Ù…Ø³Ø­ âœ”";
  const parts = text.split(";");
  let d={};
  parts.forEach(p=>{
    let [k,v]=p.split("=");
    d[k]=v;
  });

  recordAttendance({
    ID:d.ID,
    name:d.NAME,
    grade:d.GRADE,
    class:d.CLASS
  });

  setTimeout(startScanner,1200);
}

/* ================== Attendance ================== */
function recordAttendance(s){
  const now=new Date();
  attendance.push({
    ...s,
    time:now.toLocaleTimeString("ar-SA"),
    date:now.toLocaleDateString("ar-SA")
  });
  renderAttendance();
}

function renderAttendance(){
  const tb=document.querySelector("#attendanceTable tbody");
  tb.innerHTML="";
  attendance.forEach(r=>{
    tb.innerHTML+=`
    <tr class="border">
      <td>${r.ID}</td><td>${r.name}</td><td>${r.grade}</td>
      <td>${r.class}</td><td>${r.time}</td><td>${r.date}</td>
    </tr>`;
  });
}
</script>

</body>
</html>
