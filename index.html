// ======================= تصدير الغياب =======================
function exportAbsence() {
  if (!lastAbsent || lastAbsent.length === 0) {
    alert("لا يوجد بيانات غياب لتصديرها");
    return;
  }

  const wsData = [["ID","الاسم","الصف","الفصل","التاريخ"]];
  const today = new Date().toISOString().split("T")[0];

  lastAbsent.forEach(s => {
    wsData.push([s.ID, s.name, s.grade, s.class, today]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Absence");
  XLSX.writeFile(wb, "absence.xlsx");
}

// ======================= تصدير المتأخرين =======================
function exportLate() {
  const lateList = attendance.filter(r => getAttendanceStatus(r.time) === "متأخر");

  if (lateList.length === 0) {
    alert("لا يوجد متأخرون لتصديرهم");
    return;
  }

  const wsData = [["ID","الاسم","الصف","الفصل","الوقت","التاريخ"]];

  lateList.forEach(r => {
    wsData.push([r.ID, r.name, r.grade, r.class, r.time, r.date]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Late");
  XLSX.writeFile(wb, "late.xlsx");
}

// ======================= ماسح QR =======================
function startScanner() {
  document.getElementById("scanMessage").textContent =
    "هذه الصفحة مخصصة للوحة المدير، المسح يعمل في صفحة الماسح الرئيسية.";
}

// ======================= التشغيل المبدئي =======================
(async () => {
  const today = new Date().toISOString().split("T")[0];

  // تحميل الطلاب من الشيت (اختياري)
  try {
    const res = await fetch(
      "https://script.google.com/macros/s/AKfycbw3F5TiR_sP9L3-LdndSbBgQ799SkjST48B5Lhv-bcHFdqVMcLxcf9dmcmybetIWfjNFA/exec?action=getStudents"
    );
    const data = await res.json();

    students = data.map(s => ({
      ID: String(s.ID).trim(),
      name: s.name,
      grade: s.grade,
      class: s.class,
      parentMobile: String(s.parentMobile).trim(),
      token: s.token
    }));
  } catch (e) {
    console.warn("تعذر تحميل الطلاب من الشيت");
  }

  loadAttendanceFromFirebase(today, () => {
    loadAdminDashboard();
  });
})();
</script>

</div>
</div>

</body>
</html>
