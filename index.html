
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.admin-dashboard {
    padding: 20px;
    direction: rtl;
    font-family: "Tajawal", sans-serif;
}

.dashboard-title {
    text-align: center;
    margin-bottom: 25px;
    font-size: 26px;
    color: #333;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
}

.chart-card {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    text-align: center;
}

.chart-card h3 {
    margin-bottom: 15px;
    font-size: 20px;
    color: #444;
}

    body {
        font-family: "Tajawal", sans-serif;
        background: linear-gradient(135deg, #f3f6f4, #e7f1ed);
        min-height: 100vh;
    }

    .moe-green {
        color: #017c67;
    }

    .moe-btn {
        background: linear-gradient(135deg, #017c67, #029a82);
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(1, 124, 103, 0.3);
    }

    .moe-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(1, 124, 103, 0.4);
    }

    .moe-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        border-radius: 18px;
        border: 3px solid rgba(1, 124, 103, 0.15);
        padding: 22px;
        transition: all 0.3s ease;
    }

    .moe-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    }

    .tab-btn {
        transition: all 0.25s ease;
    }

    .tab-btn:hover {
        background-color: #d1fae5 !important;
        transform: translateY(-2px);
    }

    .moe-tab-active {
        background: linear-gradient(135deg, #017c67, #029a82) !important;
        color: white !important;
        box-shadow: 0 4px 10px rgba(1, 124, 103, 0.4);
    }

    table th {
        font-weight: bold;
        letter-spacing: 0.3px;
    }

    table tr:hover {
        background-color: #f0fdf4;
        transition: 0.2s;
    }

    .btn-export {
        margin-top: 10px;
        padding: 7px 14px;
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: white;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
    }
</style>

</head>

<body>
<div class="max-w-6xl mx-auto p-4 md:p-6">
<div class="moe-card shadow-md">

<!-- Header -->
<div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b pb-4">

    <div>
        <h1 class="text-4xl font-extrabold moe-green tracking-wide">
            Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨
        </h1>
        <p class="text-gray-500 mt-1 text-sm">
            Ù…Ø¯Ø±Ø³Ø© ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… Ø§Ù„Ø§Ø¨ØªØ¯Ø¦ÙŠØ© ÙˆØ§Ù„Ù…ØªÙˆØ³Ø·Ø© Ø¨Ø¶Ù…Ø¯ 
        </p>
    </div>

    <div class="text-sm bg-white px-4 py-3 rounded-xl shadow-sm border">
        <div><strong>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="todayLabel"></span></div>
        <div id="smsBalance" class="mt-1 text-xs font-semibold text-green-700">
            Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø±ØµÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...
        </div>
    </div>

</div>


<!-- Tabs -->
<div class="grid grid-cols-2 md:grid-cols-7 gap-2 mb-6">

<button onclick="openAdminSection()"class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-admin" > DASHBOARD </button>
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-excel">Ø¥Ù†Ø´Ø§Ø¡ QR</button>
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-scan">Ù…Ø³Ø­ QR</button>
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-absent">Ø§Ù„ØºÙŠØ§Ø¨</button>
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-late">Ø§Ù„ØªØ£Ø®Ø±</button>

<!-- ğŸ”¥ Ø²Ø± Ø§Ù„Ø¨Ø­Ø« -->
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-search">Ø§Ù„Ø¨Ø­Ø«</button>

</div>
<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± -->
<div id="section-admin" class="section hidden">


    <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">

        <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
            <p id="adminTotalStudents" class="text-2xl font-bold moe-green">0</p>
        </div>

        <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ† Ø§Ù„ÙŠÙˆÙ…</p>
            <p id="adminPresent" class="text-2xl font-bold text-green-700">0</p>
        </div>

        <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">Ø§Ù„ØªØ£Ø®Ø±</p>
            <p id="adminLate" class="text-2xl font-bold text-orange-600">0</p>
        </div>

        <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">Ø§Ù„ØºÙŠØ§Ø¨</p>
            <p id="adminAbsent" class="text-2xl font-bold text-red-600">0</p>
        </div>

    </div>

    <!-- Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± -->
    <div class="moe-card text-center mb-8">
        <p class="text-gray-600 text-sm mb-1">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</p>
        <p id="adminRate" class="text-3xl font-bold text-blue-700">0%</p>
    </div>

    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="admin-dashboard">

        <div class="charts-grid">

            <div class="chart-card">
                <h3>Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                <canvas id="dailyAbsenceChart"></canvas>
            </div>

            <div class="chart-card">
                <h3>Ø§Ù„ØªØ£Ø®Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                <canvas id="dailyLateChart"></canvas>
            </div>

            <div class="chart-card">
                <h3>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØµÙÙˆÙ (ØºÙŠØ§Ø¨)</h3>
                <canvas id="gradeAbsenceChart"></canvas>
            </div>

        </div>

    </div>

    <!-- Ù…ÙƒØªØ¨Ø© Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</div>


<!-- Ø¥Ù†Ø´Ø§Ø¡ QR -->
<div id="section-excel" class="section hidden">

    <div class="flex flex-col md:flex-row gap-4 items-center mb-3">
        <input id="excelFile" type="file" accept=".xls,.xlsx" class="border rounded px-3 py-2 text-sm bg-gray-50" />
        <button id="btnImportExcel" class="moe-btn px-4 py-2 rounded-lg text-sm font-semibold">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
    </div>

    <div id="excelStatus" class="text-sm text-gray-600 mb-3"></div>
    <div id="studentsContainer"></div>
</div>

<!-- Ù…Ø³Ø­ QR -->
<div id="section-scan" class="section hidden">
    <div id="reader" class="w-full max-w-md mx-auto border-2 border-green-700 rounded-xl"></div>
    <p id="scanMessage" class="text-center mt-4 text-sm font-bold"></p>
</div>

<!-- Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
<div id="section-attendance" class="section hidden">
    <div class="moe-card overflow-x-auto">
        <table class="min-w-full text-sm" id="attendanceTable">
            <thead class="bg-green-700 text-white">
                <tr>
                    <th class="px-3 py-2">ID</th>
                    <th class="px-3 py-2">Ø§Ù„Ø§Ø³Ù…</th>
                    <th class="px-3 py-2">Ø§Ù„ØµÙ</th>
                    <th class="px-3 py-2">Ø§Ù„ÙØµÙ„</th>
                    <th class="px-3 py-2">Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                    <th class="px-3 py-2">Ø§Ù„ÙˆÙ‚Øª</th>
                    <th class="px-3 py-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th class="px-3 py-2">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Ø§Ù„ØºÙŠØ§Ø¨ -->
<div id="section-absent" class="section hidden">
    <div class="moe-card overflow-x-auto">
        <table class="min-w-full text-sm" id="absentTable">
            <thead class="bg-red-600 text-white">
                <tr>
                    <th class="px-3 py-2">ID</th>
                    <th class="px-3 py-2">Ø§Ù„Ø§Ø³Ù…</th>
                    <th class="px-3 py-2">Ø§Ù„ØµÙ</th>
                    <th class="px-3 py-2">Ø§Ù„ÙØµÙ„</th>
                    <th class="px-3 py-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
		<button onclick="sendAllAbsenceSMS()" class="btn-export" style="background:#047857">
    Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºÙŠØ§Ø¨
</button>

        <button onclick="exportAbsence()" class="btn-export">ØªØµØ¯ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨</button>
		
    </div>
</div>

<!-- Ø§Ù„Ù…ØªØ£Ø®Ø±ÙˆÙ† -->
<div id="section-late" class="section hidden">
    <div class="moe-card overflow-x-auto">
        <table class="min-w-full text-sm" id="lateTable">
            <thead class="bg-orange-500 text-white">
                <tr>
                    <th class="px-3 py-2">ID</th>
                    <th class="px-3 py-2">Ø§Ù„Ø§Ø³Ù…</th>
                    <th class="px-3 py-2">Ø§Ù„ØµÙ</th>
                    <th class="px-3 py-2">Ø§Ù„ÙØµÙ„</th>
                    <th class="px-3 py-2">Ø§Ù„ÙˆÙ‚Øª</th>
                    <th class="px-3 py-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="exportLate()" class="btn-export">ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†</button>
    </div>
</div>

<!-- ğŸ”¥ Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« (Ø¨Ø¹Ø¯ Ø¯Ù…Ø¬ Ø¨Ø­Ø« Ø¨ÙŠÙ† ØªØ§Ø±ÙŠØ®ÙŠÙ†) -->
<div id="section-search" class="section hidden">
    <h2 class="text-xl font-bold moe-green mb-4">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØºÙŠØ§Ø¨ Ø·Ø§Ù„Ø¨</h2>

    <div class="moe-card p-4 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

            <div>
                <label class="block mb-1 font-semibold">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (ID)</label>
                <input id="searchID" type="text" class="w-full border p-2 rounded" placeholder="Ù…Ø«Ø§Ù„: 1059">
            </div>

            <div>
                <label class="block mb-1 font-semibold">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input id="searchFrom" type="date" class="w-full border p-2 rounded">
            </div>

            <div>
                <label class="block mb-1 font-semibold">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input id="searchTo" type="date" class="w-full border p-2 rounded">
            </div>

            <div class="flex items-end">
                <button onclick="searchBetweenDates()" class="moe-btn px-4 py-2 rounded-lg w-full">
                    Ø¨Ø­Ø« Ø¨ÙŠÙ† ØªØ§Ø±ÙŠØ®ÙŠÙ†
                </button>
            </div>

        </div>
    </div>

    <div class="moe-card overflow-x-auto">
        <table class="min-w-full text-sm" id="searchResultTable">
            <thead class="bg-blue-600 text-white">
                <tr align="center">
                    <th class="px-3 py-2">ID</th>
                    <th class="px-3 py-2">Ø§Ù„Ø§Ø³Ù…</th>
                    <th class="px-3 py-2">Ø§Ù„ØµÙ</th>
                    <th class="px-3 py-2">Ø§Ù„ÙØµÙ„</th>
                    <th class="px-3 py-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th class="px-3 py-2">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
/* ===========================================================
   ğŸ”¥ Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
=========================================================== */

function formatTime(isoString) {
  if (!isoString) return "";
  const date = new Date(isoString);
  return date.toLocaleTimeString("ar-SA", {
    hour: "2-digit",
    minute: "2-digit",
    hour12: true
  });
}

function formatDate(isoString) {
  if (!isoString) return "";
  const date = new Date(isoString);
  return date.toLocaleDateString("ar-SA", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  });
}

function openAdminSection() {
    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    document.querySelectorAll(".section").forEach(sec => sec.classList.add("hidden"));

    // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
    document.getElementById("section-admin").classList.remove("hidden");

    // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø­ØªÙ‰ ØªØ¸Ù‡Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø«Ù… Ù†Ø±Ø³Ù… Ø§Ù„Ø±Ø³ÙˆÙ…
    setTimeout(() => {
        loadAdminDashboard();
    }, 200);
}

/* ===========================================================
   ğŸ”¥ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ â†’ Ù‡Ø¬Ø±ÙŠ
=========================================================== */
function toHijri(dateInput) {
    if (!dateInput) return "";

    const date = new Date(dateInput);

    const formatted = new Intl.DateTimeFormat("ar-SA-u-ca-islamic", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
    }).format(date);

    return formatted 
}

document.getElementById("todayLabel").textContent =
  new Date().toLocaleDateString("ar-SA");

/* ===========================================================
   ğŸ”¥ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
=========================================================== */
const API_URL = "https://script.google.com/macros/s/AKfycbw3F5TiR_sP9L3-LdndSbBgQ799SkjST48B5Lhv-bcHFdqVMcLxcf9dmcmybetIWfjNFA/exec";
	const SMS_API_URL = "https://app.mobile.net.sa/api/v1/send";
const SMS_BALANCE_URL = "https://app.mobile.net.sa/api/v1/get-balance";
const SMS_API_KEY = "XRGdRQaYcesQbFy6rtzS2pOGARSHXBG7yAqC4rDr";
const SMS_SENDER_NAME = "School1";

let students = [];
let attendance = [];
let scanner = null;
let smsTarget = null;

/* ===========================================================
   ğŸ”¥ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ§Ø¨Ø§Øª
=========================================================== */
document.querySelectorAll(".tab-btn").forEach((btn) => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".section").forEach((s) => s.classList.add("hidden"));
    document.getElementById(btn.dataset.target).classList.remove("hidden");

    document.querySelectorAll(".tab-btn").forEach((b) =>
      b.classList.remove("moe-tab-active")
    );
    btn.classList.add("moe-tab-active");

    if (btn.dataset.target === "section-scan") setTimeout(() => startScanner(), 500);
    if (btn.dataset.target === "section-attendance") renderAttendance();
    if (btn.dataset.target === "section-absent") renderAbsent();
    if (btn.dataset.target === "section-late") renderLate();
    if (btn.dataset.target === "section-admin") loadDashboard();
  });
});

/* ===========================================================
   ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨ØªØ§Ø±ÙŠØ® ÙˆØ§Ø­Ø¯

=========================================================== */
function searchAbsenceByDate() {
  const id = document.getElementById("searchID").value.trim();
  const date = document.getElementById("searchDate")?.value?.trim();
  const tbody = document.querySelector("#searchResultTable tbody");
  tbody.innerHTML = "";

  if (!id || !date) {
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®");
    return;
  }

  const results = attendance.filter(r =>
    r.ID == id &&
    r.date.startsWith(date) &&
    r.status.trim() === "ØºØ§Ø¦Ø¨"
  );

  if (results.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="py-3 text-center text-red-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>`;
    return;
  }

  results.forEach(r => {
    tbody.innerHTML += `
      <tr align="center" class="border-b">
        <td>${r.ID}</td>
        <td>${r.name}</td>
        <td>${r.grade}</td>
        <td>${r.class}</td>
        <td>${formatDate(r.date)}</td>
        <td>${r.status}</td>
      </tr>
    `;
  });
}

/* ===========================================================
   ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨ÙŠÙ† ØªØ§Ø±ÙŠØ®ÙŠÙ† (ØºÙŠØ§Ø¨ ÙÙ‚Ø·)
=========================================================== */
function searchBetweenDates() {
  const id = document.getElementById("searchID").value.trim();
  const from = document.getElementById("searchFrom").value;
  const to = document.getElementById("searchTo").value;

  const tbody = document.querySelector("#searchResultTable tbody");
  tbody.innerHTML = "";

  if (!id || !from || !to) {
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");
    return;
  }

  const fromDate = new Date(from);
  const toDate = new Date(to);

  const results = attendance.filter(r => {
    if (r.ID != id) return false;
    if (r.status.trim() !== "ØºØ§Ø¦Ø¨") return false;

    const d = new Date(r.date);
    return d >= fromDate && d <= toDate;
  });

  if (results.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="py-3 text-center text-red-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>`;
    return;
  }

  results.forEach(r => {
    tbody.innerHTML += `
      <tr align="center" class="border-b">
        <td>${r.ID}</td>
        <td>${r.name}</td>
        <td>${r.grade}</td>
        <td>${r.class}</td>
        <td>${formatDate(r.date)}</td>
        <td>${r.status}</td>
      </tr>
    `;
  });
}

/* ===========================================================
   ğŸ”¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Excel
=========================================================== */
document.getElementById("btnImportExcel").onclick = () => {
  const file = document.getElementById("excelFile").files[0];
  if (!file) return alert("Ø§Ø®ØªØ± Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹");

  const reader = new FileReader();
  reader.onload = (e) => {
    const wb = XLSX.read(e.target.result, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);

    students = json.map((r) => ({
      ID: String(r.ID || "").trim(),
      name: r.Name || "",
      grade: r.Grade || "",
      class: r.Class || "",
      parentMobile: String(r.ParentMobile || "").trim(),
      token: Math.random().toString(36).substring(2, 10)
    }));

    document.getElementById("excelStatus").textContent =
      "ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ " + students.length + " Ø·Ø§Ù„Ø¨.";

    renderStudents();
    students.forEach((s) => saveStudentToSheet(s));
    updateStats();
  };

  reader.readAsArrayBuffer(file);
};

function saveStudentToSheet(s) {
  const form = new URLSearchParams();
  form.append("action", "addStudent");
  form.append("ID", s.ID);
  form.append("name", s.name);
  form.append("grade", s.grade);
  form.append("class", s.class);
  form.append("parentMobile", s.parentMobile);
  form.append("token", s.token);
  fetch(API_URL, { method: "POST", body: form });
}
function getFirstName(fullName) {
    if (!fullName) return "";
    return fullName.split(" ")[0]; // ÙŠØ£Ø®Ø° Ø£ÙˆÙ„ ÙƒÙ„Ù…Ø© ÙÙ‚Ø·
}

async function sendAbsenceSMS(student) {
    try {
        const mobile = normalizeMobile(student.parentMobile);
        if (!mobile) {
            console.warn("Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­:", student.parentMobile);
            return;
        }

        const firstName = getFirstName(student.name);
        const hijriDate = toHijri(new Date());

        // ğŸ”¥ Ø±Ù‚Ù… Ù…ØªØºÙŠØ± ÙŠÙ…Ù†Ø¹ Ø±ÙØ¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø³Ø¨Ø¨ duplicate message
        const stamp = new Date().getTime().toString().slice(-4);

        // ğŸ”¥ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ù…Ø¬
        const msg = `Ø§Ø¨Ù†ÙƒÙ… ${firstName} ØºØ§Ø¨ Ø¹Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠÙˆÙ… ${hijriDate} â€“ ${stamp}`;

        const payload = {
            number: mobile,
            senderName: SMS_SENDER_NAME,
            sendAtOption: "NOW",
            messageBody: msg,
        };

        const res = await fetch(SMS_API_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + SMS_API_KEY,
            },
            body: JSON.stringify(payload),
        });

        const result = await res.json().catch(() => null);

        console.log("Ø±Ø¯ API:", result);

        if (!result) {
            alert("Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø¯ Ù…Ù† Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©");
            return;
        }

        if (result.status !== "Success" && result.status !== "success") {
            alert("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: " + JSON.stringify(result));
            return;
        }

        console.log("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØºÙŠØ§Ø¨ Ø¥Ù„Ù‰:", student.name);

    } catch (err) {
        console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØºÙŠØ§Ø¨:", err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + err.message);
    }
}


async function sendAllAbsenceSMS() {
    const absent = attendance.filter(r => r.status.trim() === "ØºØ§Ø¦Ø¨");

    if (absent.length === 0) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ØºØ§Ø¦Ø¨ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…");
        return;
    }

    for (const stu of absent) {
        await sendAbsenceSMS(stu);
        await new Promise(r => setTimeout(r, 500)); // Ù…Ù‡Ù„Ø© Ù†ØµÙ Ø«Ø§Ù†ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    }

    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ø¬Ù…ÙŠØ¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±");
}


/* ===========================================================
   ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨ + QR
=========================================================== */
function renderStudents() {
  let html = `
<table class="min-w-full text-sm">
<thead class="bg-green-700 text-white">
<tr>
<th class="px-3 py-2">ID</th>
<th class="px-3 py-2">Ø§Ù„Ø§Ø³Ù…</th>
<th class="px-3 py-2">Ø§Ù„ØµÙ</th>
<th class="px-3 py-2">Ø§Ù„ÙØµÙ„</th>
<th class="px-3 py-2">Ø§Ù„Ø¬ÙˆØ§Ù„</th>
<th class="px-3 py-2">QR</th>
<th class="px-3 py-2">SMS</th>
</tr>
</thead>
<tbody>
`;

  students.forEach((s) => {
    const qrData = JSON.stringify({
      ID: s.ID,
      TOKEN: s.token,
      NAME: s.name,
      GRADE: s.grade,
      CLASS: s.class,
      parentMobile: s.parentMobile
    });

    const qrUrl =
      "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" +
      encodeURIComponent(qrData);

    html += `
<tr class="border-b">
<td class="px-3 py-2">${s.ID}</td>
<td class="px-3 py-2">${s.name}</td>
<td class="px-3 py-2">${s.grade}</td>
<td class="px-3 py-2">${s.class}</td>
<td class="px-3 py-2">${s.parentMobile}</td>
<td class="px-3 py-2"><img src="${qrUrl}" class="w-16 mx-auto"/></td>
<td class="px-3 py-2">
<button onclick="openSMSModal('${s.ID}')" class="moe-btn px-3 py-1 rounded text-xs">SMS</button>
</td>
</tr>
`;
  });

  html += "</tbody></table>";
  document.getElementById("studentsContainer").innerHTML = html;
}

/* ===========================================================
   ğŸ”¥ SMS
=========================================================== */
function openSMSModal(id) {
  smsTarget = students.find((s) => s.ID == id) || attendance.find(a => a.ID == id);
  if (!smsTarget) {
    alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨");
    return;
  }
  document.getElementById("smsTargetLabel").textContent =
    `Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ ${smsTarget.name} (${smsTarget.parentMobile})`;
  document.getElementById("smsModal").classList.remove("hidden");
}

function closeSMSModal() {
  document.getElementById("smsModal").classList.add("hidden");
}

function normalizeMobile(n) {
  n = String(n).replace(/\D/g, "");
  if (n.startsWith("966")) return n;
  if (n.startsWith("05")) return "966" + n.slice(1);
  if (n.startsWith("5")) return "966" + n;
  return n;
}

async function loadStudentsFromSheet() {
    try {
        const res = await fetch(API_URL + "?action=getStudents");
        const data = await res.json();

        students = data.map(s => ({
            ID: String(s.ID).trim(),
            name: s.name,
            grade: s.grade,
            class: s.class,
            parentMobile: String(s.parentMobile).trim(),
            token: s.token
        }));
console.log("Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ù…Ù‘Ù„ÙŠÙ†:", students.length);

        console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨:", students.length);

        updateStats(); // â† Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹

    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨:", e);
    }
}

async function confirmSendSMS() {
  const msg = document.getElementById("smsMessage").value.trim();
  if (!msg) return alert("Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");

  const mobile = normalizeMobile(smsTarget.parentMobile);
  if (!mobile) return alert("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ§Ù„Ø­");

  const payload = {
    number: mobile,
    senderName: SMS_SENDER_NAME,
    sendAtOption: "NOW",
    messageBody: msg,
  };

  await fetch(SMS_API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + SMS_API_KEY,
    },
    body: JSON.stringify(payload),
  });

  alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
  closeSMSModal();
}

/* ===========================================================
   ğŸ”¥ QR Scanner
=========================================================== */
function startScanner() {
  if (scanner) { try { scanner.stop(); } catch(e){} }

  scanner = new Html5Qrcode("reader");
  const config = {
    fps: 10,
    qrbox: { width: 280, height: 280 },
    aspectRatio: 1.0,
    experimentalFeatures: { useBarCodeDetectorIfSupported: true }
  };

  const onScan = (decodedText) => {
    try { scanner.stop(); } catch(e){}
    handleQR(decodedText);
  };

  scanner.start(
    { facingMode: { exact: "environment" } },
    config,
    onScan,
    () => {}
  ).catch(() => {
    Html5Qrcode.getCameras().then((cams) => {
      if (!cams.length) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…ØªØ§Ø­Ø©"); return; }

      let backCam = cams.find(c =>
        c.label.toLowerCase().includes("back") ||
        c.label.toLowerCase().includes("rear")
      );

      let camId = backCam ? backCam.id : cams[0].id;

      scanner.start(
        camId,
        config,
        onScan,
        () => {}
      );
    });
  });
}

/* ===========================================================
   ğŸ”¥ Ù‚Ø±Ø§Ø¡Ø© QR
=========================================================== */
function handleQR(text) {
  document.getElementById("scanMessage").textContent = "ØªÙ… Ø§Ù„Ù…Ø³Ø­ âœ”";

  let data;
  try {
    data = JSON.parse(text);
  } catch (e) {
    document.getElementById("scanMessage").textContent = "QR ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„";
    return;
  }

  if (!data.ID || !data.TOKEN) {
    document.getElementById("scanMessage").textContent =
      "QR Ù†Ø§Ù‚Øµ â€“ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±";
    return;
  }

  recordAttendance({
    ID: data.ID,
    name: data.NAME || data.name || "",
    grade: data.GRADE || data.grade || "",
    class: data.CLASS || data.class || "",
    parentMobile: data.parentMobile || data.PARENT || "",
    token: data.TOKEN || data.token
  });

  try { scanner.stop(); } catch(e){}
  setTimeout(() => startScanner(), 1200);
}

/* ===========================================================
   ğŸ”¥ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
=========================================================== */
function recordAttendance(stu) {
  if (!stu.ID) { alert("QR ØºÙŠØ± ØµØ§Ù„Ø­"); return; }

  const form = new URLSearchParams();
  form.append("action", "attendance");
  form.append("ID", stu.ID);
  form.append("name", stu.name);
  form.append("grade", stu.grade);
  form.append("class", stu.class);
  form.append("parentMobile", stu.parentMobile);
  form.append("token", stu.token);

  fetch(API_URL, { method: "POST", body: form })
    .then(r => r.text())
    .then(msg => {
      document.getElementById("scanMessage").textContent = msg;
      loadAttendanceFromSheet();
    })
    .catch(e => console.error(e));
}

/* ===========================================================
   ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±
=========================================================== */
async function loadAttendanceFromSheet() {
  const res = await fetch(API_URL + "?action=getAttendance");
  const data = await res.json();
  attendance = data;
  updateStats();
}

/* ===========================================================
   ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¶ÙˆØ±
=========================================================== */
function renderAttendance() {
  const tbody = document.querySelector("#attendanceTable tbody");
  tbody.innerHTML = "";

  // Ø¹Ø±Ø¶ ÙƒÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…: Ø­Ø§Ø¶Ø± + Ù…ØªØ£Ø®Ø± + ØºØ§Ø¦Ø¨
  const todayRecords = attendance.filter(r => {
    if (!r.date) return false;
    const dt = new Date(r.date);
    const today = new Date();
    return (
      dt.getFullYear() === today.getFullYear() &&
      dt.getMonth() === today.getMonth() &&
      dt.getDate() === today.getDate()
    );
  });

  todayRecords.forEach((r) => {
    tbody.innerHTML += `
<tr align=center class="border-b">
  <td>${r.ID}</td>
  <td>${r.name}</td>
  <td>${r.grade}</td>
  <td>${r.class}</td>
  <td>${r.parentMobile}</td>
  <td>${formatTime(r.time)}</td>
  <td>${formatDate(r.date)}</td>
  <td>${r.status}</td>
</tr>`;
  });
}

/* ===========================================================
   ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„ØºÙŠØ§Ø¨
=========================================================== */
function renderAbsent() {
  const tbody = document.querySelector("#absentTable tbody");
  tbody.innerHTML = "";

  const absent = attendance.filter(r => r.status.trim() === "ØºØ§Ø¦Ø¨");

  absent.forEach((r) => {
    tbody.innerHTML += `
<tr align=center class="border-b">
  <td class="px-3 py-2">${r.ID}</td>
  <td class="px-3 py-2">${r.name}</td>
  <td class="px-3 py-2">${r.grade}</td>
  <td class="px-3 py-2">${r.class}</td>
  <td class="px-3 py-2">${formatDate(r.date)}</td>
</tr>`;
  });
}

/* ===========================================================
   ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†
=========================================================== */
function renderLate() {
  const tbody = document.querySelector("#lateTable tbody");
  tbody.innerHTML = "";

  const late = attendance.filter(r => r.status.trim() === "Ù…ØªØ£Ø®Ø±");

  late.forEach((r) => {
    tbody.innerHTML += `
<tr align=center class="border-b">
  <td class="px-3 py-2">${r.ID}</td>
  <td class="px-3 py-2">${r.name}</td>
  <td class="px-3 py-2">${r.grade}</td>
  <td class="px-3 py-2">${r.class}</td>
  <td class="px-3 py-2">${formatTime(r.time)}</td>
  <td class="px-3 py-2">${formatDate(r.date)}</td>
</tr>`;
  });
}

/* ===========================================================
   ğŸ”¥ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ø³Ù‘Ù†)
=========================================================== */
function updateStats() {
    const totalStudents = students.length;

    const today = new Date();
    const y = today.getFullYear();
    const m = today.getMonth();
    const d = today.getDate();

    const todayRecords = attendance.filter(a => {
        if (!a.date) return false;
        const dt = new Date(a.date);
        return dt.getFullYear() === y && dt.getMonth() === m && dt.getDate() === d;
    });

    const presentOnly = todayRecords.filter(a => a.status === "Ø­Ø§Ø¶Ø±").length;
    const late = todayRecords.filter(a => a.status === "Ù…ØªØ£Ø®Ø±").length;

    // Ø§Ù„Ù…ØªØ£Ø®Ø± ÙŠØ¹ØªØ¨Ø± Ø­Ø§Ø¶Ø±
    const present = presentOnly + late;

    const absent = totalStudents - present;

    document.getElementById("adminTotalStudents").textContent = totalStudents;
    document.getElementById("adminPresent").textContent = present;
    document.getElementById("adminLate").textContent = late;
    document.getElementById("adminAbsent").textContent = absent;

    const rate = totalStudents > 0 ? Math.round((present / totalStudents) * 100) : 0;
    document.getElementById("adminRate").textContent = rate + "%";
}
function exportAbsence() {
    const absent = attendance.filter(r => r.status.trim() === "ØºØ§Ø¦Ø¨");

    if (absent.length === 0) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ Ù„ØªØµØ¯ÙŠØ±Ù‡");
        return;
    }

    const rows = absent.map(r => {
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙˆÙ‚Øª
        const dateOnly = r.date.split("T")[0]; // Ù…Ø«Ø§Ù„: 2026-03-09

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡
        const parts = dateOnly.split("-");
        const y = parseInt(parts[0]);
        const m = parseInt(parts[1]) - 1;
        const d = parseInt(parts[2]);

        // Ø¥Ù†Ù‚Ø§Øµ ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯
        const corrected = new Date(y, m, d, 12, 0, 0);

        // ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Ù†Øµ Ø¨Ù†ÙØ³ ØµÙŠØºØ© yyyy-mm-dd
        const correctedStr = corrected.toISOString().split("T")[0];

        return {
            ID: r.ID,
            Ø§Ù„Ø§Ø³Ù…: r.name,
            Ø§Ù„ØµÙ: r.grade,
            Ø§Ù„ÙØµÙ„: r.class,
            Ø§Ù„ØªØ§Ø±ÙŠØ®_Ø§Ù„Ù‡Ø¬Ø±ÙŠ: toHijri(correctedStr)
        };
    });

    const ws = XLSX.utils.json_to_sheet(rows);

    ws['!cols'] = [
        { wch: 10 },
        { wch: 20 },
        { wch: 10 },
        { wch: 10 },
        { wch: 20 }
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ØºÙŠØ§Ø¨");

    XLSX.writeFile(wb, "ØºÙŠØ§Ø¨_Ø§Ù„Ø·Ù„Ø§Ø¨_Ù‡Ø¬Ø±ÙŠ.xlsx");
}

function exportLate() {
    const late = attendance.filter(r => r.status.trim() === "Ù…ØªØ£Ø®Ø±");

    if (late.length === 0) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ£Ø®Ø±ÙˆÙ† Ù„ØªØµØ¯ÙŠØ±Ù‡Ù…");
        return;
    }

    const rows = late.map(r => {
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙˆÙ‚Øª
        const dateOnly = r.date.split("T")[0]; // Ù…Ø«Ø§Ù„: 2026-03-09

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡
        const parts = dateOnly.split("-");
        const y = parseInt(parts[0]);
        const m = parseInt(parts[1]) - 1;
        const d = parseInt(parts[2]);

        // Ø¥Ù†Ù‚Ø§Øµ ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ Ù„Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© UTC
        const corrected = new Date(y, m, d, 12, 0, 0);

        // ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Ù†Øµ yyyy-mm-dd
        const correctedStr = corrected.toISOString().split("T")[0];

        return {
            ID: r.ID,
            Ø§Ù„Ø§Ø³Ù…: r.name,
            Ø§Ù„ØµÙ: r.grade,
            Ø§Ù„ÙØµÙ„: r.class,
            Ø§Ù„ÙˆÙ‚Øª: formatTime(r.time),
            Ø§Ù„ØªØ§Ø±ÙŠØ®_Ø§Ù„Ù‡Ø¬Ø±ÙŠ: toHijri(correctedStr)
        };
    });

    const ws = XLSX.utils.json_to_sheet(rows);

    ws['!cols'] = [
        { wch: 10 },
        { wch: 20 },
        { wch: 10 },
        { wch: 10 },
        { wch: 12 },
        { wch: 20 }
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…ØªØ£Ø®Ø±ÙˆÙ†");

    XLSX.writeFile(wb, "Ø§Ù„Ù…ØªØ£Ø®Ø±ÙˆÙ†_Ù‡Ø¬Ø±ÙŠ.xlsx");
}

/* ===========================================================
   ğŸ”¥ Ø±ØµÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
=========================================================== */
async function getBalance() {
  const res = await fetch(SMS_BALANCE_URL, {
    method: "POST",
    headers: { Authorization: "Bearer " + SMS_API_KEY },
  });

  let balance = "ØºÙŠØ± Ù…ØªØ§Ø­";
  try {
    const data = await res.json();
    balance = data.data.balance;
  } catch {}

  document.getElementById("smsBalance").textContent =
    "Ø±ØµÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: " + balance;
}

loadStudentsFromSheet();
loadAttendanceFromSheet();
updateStats();

getBalance();

// -----------------------------
// 1) Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ
// -----------------------------
function getDailyAbsenceStats() {
    const stats = {};

    attendance.forEach(r => {
        if (r.status === "ØºØ§Ø¦Ø¨") {
            const date = r.date.split("T")[0];
            stats[date] = (stats[date] || 0) + 1;
        }
    });

    return stats;
}

// -----------------------------
// 2) Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ£Ø®Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ
// -----------------------------
function getDailyLateStats() {
    const stats = {};

    attendance.forEach(r => {
        if (r.status === "Ù…ØªØ£Ø®Ø±") {
            const date = r.date.split("T")[0];
            stats[date] = (stats[date] || 0) + 1;
        }
    });

    return stats;
}

// -----------------------------
// 3) Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØµÙÙˆÙ (ØºÙŠØ§Ø¨)
// -----------------------------
function getGradeAbsenceStats() {
    const stats = {};

    attendance.forEach(r => {
        if (r.status === "ØºØ§Ø¦Ø¨") {
            stats[r.grade] = (stats[r.grade] || 0) + 1;
        }
    });

    return stats;
}

// -----------------------------
// 4) Ø±Ø³Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ
// -----------------------------
function renderDailyAbsenceChart() {
    const stats = getDailyAbsenceStats();

    new Chart(document.getElementById("dailyAbsenceChart"), {
        type: "bar",
        data: {
            labels: Object.keys(stats),
            datasets: [{
                label: "Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨",
                data: Object.values(stats),
                backgroundColor: "#ff4d4d"
            }]
        }
    });
}

// -----------------------------
// 5) Ø±Ø³Ù… Ø§Ù„ØªØ£Ø®Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ
// -----------------------------
function renderDailyLateChart() {
    const stats = getDailyLateStats();

    new Chart(document.getElementById("dailyLateChart"), {
        type: "bar",
        data: {
            labels: Object.keys(stats),
            datasets: [{
                label: "Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†",
                data: Object.values(stats),
                backgroundColor: "#4d79ff"
            }]
        }
    });
}

// -----------------------------
// 6) Ø±Ø³Ù… Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØµÙÙˆÙ
// -----------------------------
function renderGradeAbsenceChart() {
    const stats = getGradeAbsenceStats();

    new Chart(document.getElementById("gradeAbsenceChart"), {
        type: "pie",
        data: {
            labels: Object.keys(stats),
            datasets: [{
                data: Object.values(stats),
                backgroundColor: [
                    "#ff9999",
                    "#66b3ff",
                    "#99ff99",
                    "#ffcc99",
                    "#c299ff",
                    "#ffb366"
                ]
            }]
        }
    });
}

// -----------------------------
// 7) ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… Ø¹Ù†Ø¯ ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
// -----------------------------
function loadAdminDashboard() {
    renderDailyAbsenceChart();
    renderDailyLateChart();
    renderGradeAbsenceChart();
}

</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>
</html>




