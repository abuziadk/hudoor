<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.admin-dashboard {
    padding: 20px;
    direction: rtl;
    font-family: "Tajawal", sans-serif;
}

.dashboard-title {
    text-align: center;
    margin-bottom: 25px;
    font-size: 26px;
    color: #333;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
}

.chart-card {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    text-align: center;
}

.chart-card h3 {
    margin-bottom: 15px;
    font-size: 20px;
    color: #444;
}

body {
    font-family: "Tajawal", sans-serif;
    background: linear-gradient(135deg, #f3f6f4, #e7f1ed);
    min-height: 100vh;
}

.moe-green {
    color: #017c67;
}

.moe-btn {
    background: linear-gradient(135deg, #017c67, #029a82);
    color: white;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(1, 124, 103, 0.3);
}

.moe-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(1, 124, 103, 0.4);
}

.moe-card {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    border-radius: 18px;
    border: 3px solid rgba(1, 124, 103, 0.15);
    padding: 22px;
    transition: all 0.3s ease;
}

.moe-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
}

.tab-btn {
    transition: all 0.25s ease;
}

.tab-btn:hover {
    background-color: #d1fae5 !important;
    transform: translateY(-2px);
}

.moe-tab-active {
    background: linear-gradient(135deg, #017c67, #029a82) !important;
    color: white !important;
    box-shadow: 0 4px 10px rgba(1, 124, 103, 0.4);
}

table th {
    font-weight: bold;
    letter-spacing: 0.3px;
}

table tr:hover {
    background-color: #f0fdf4;
    transition: 0.2s;
}

.btn-export {
    margin-top: 10px;
    padding: 7px 14px;
    background: linear-gradient(135deg, #2563eb, #1e40af);
    color: white;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
}
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

</head>

<body>
<div class="max-w-6xl mx-auto p-4 md:p-6">
<div class="moe-card shadow-md">

<!-- Header -->
<div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b pb-4">

    <div>
        <h1 class="text-4xl font-extrabold moe-green tracking-wide">
            Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨
        </h1>
        <p class="text-gray-500 mt-1 text-sm">
            Ù…Ø¯Ø±Ø³Ø© ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… Ø§Ù„Ø§Ø¨ØªØ¯Ø¦ÙŠØ© ÙˆØ§Ù„Ù…ØªÙˆØ³Ø·Ø© Ø¨Ø¶Ù…Ø¯ 
        </p>
    </div>

    <div class="text-sm bg-white px-4 py-3 rounded-xl shadow-sm border">
        <div><strong>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="todayLabel"></span></div>
        <div id="smsBalance" class="mt-1 text-xs font-semibold text-green-700">
            Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø±ØµÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...
        </div>
    </div>

</div>

<!-- Tabs -->
<div class="grid grid-cols-2 md:grid-cols-7 gap-2 mb-6">

<button onclick="openAdminSection()" class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold moe-tab-active" data-target="section-admin">DASHBOARD</button>
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-excel">Ø¥Ù†Ø´Ø§Ø¡ QR</button>
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-scan">Ù…Ø³Ø­ QR</button>
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-absent">Ø§Ù„ØºÙŠØ§Ø¨</button>
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-late">Ø§Ù„ØªØ£Ø®Ø±</button>
<button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-search">Ø§Ù„Ø¨Ø­Ø«</button>

</div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± -->
<div id="section-admin" class="section">

    <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">

        <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
            <p id="adminTotalStudents" class="text-2xl font-bold moe-green">0</p>
        </div>

        <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ† Ø§Ù„ÙŠÙˆÙ…</p>
            <p id="adminPresent" class="text-2xl font-bold text-green-700">0</p>
        </div>

        <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">Ø§Ù„ØªØ£Ø®Ø±</p>
            <p id="adminLate" class="text-2xl font-bold text-orange-600">0</p>
        </div>

        <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">Ø§Ù„ØºÙŠØ§Ø¨</p>
            <p id="adminAbsent" class="text-2xl font-bold text-red-600">0</p>
        </div>

    </div>

    <!-- ğŸ”¥ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙˆÙ‚Øª -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">

        <div class="moe-card text-center">
            <label class="font-bold text-gray-700">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¶ÙˆØ± (StartPresent)</label>
            <input type="time" id="StartPresent" value="06:00"
                   class="border p-2 rounded mt-2 text-center w-full">
        </div>

        <div class="moe-card text-center">
            <label class="font-bold text-gray-700">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¶ÙˆØ± (EndPresent)</label>
            <input type="time" id="EndPresent" value="07:30"
                   class="border p-2 rounded mt-2 text-center w-full">
        </div>

        <div class="moe-card text-center">
            <label class="font-bold text-gray-700">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ£Ø®Ø± (EndLate)</label>
            <input type="time" id="EndLate" value="08:00"
                   class="border p-2 rounded mt-2 text-center w-full">
        </div>

    </div>

    <!-- Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± -->
    <div class="moe-card text-center mb-8">
        <p class="text-gray-600 text-sm mb-1">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</p>
        <p id="adminRate" class="text-3xl font-bold text-blue-700">0%</p>
    </div>

    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="admin-dashboard">

        <div class="charts-grid">

            <div class="chart-card">
                <h3>Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                <canvas id="dailyAbsenceChart"></canvas>
            </div>

            <div class="chart-card">
                <h3>Ø§Ù„ØªØ£Ø®Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                <canvas id="dailyLateChart"></canvas>
            </div>

            <div class="chart-card">
                <h3>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØµÙÙˆÙ (ØºÙŠØ§Ø¨)</h3>
                <canvas id="gradeAbsenceChart"></canvas>
            </div>

        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</div>
<!-- Ù…Ø³Ø­ QR -->
<div id="section-scan" class="section hidden">
    <div id="reader" class="w-full max-w-md mx-auto border-2 border-green-700 rounded-xl"></div>
    <p id="scanMessage" class="text-center mt-4 text-sm font-bold"></p>
</div>

<!-- Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
<div id="section-attendance" class="section hidden">
    <div class="moe-card overflow-x-auto">
        <table class="min-w-full text-sm" id="attendanceTable">
            <thead class="bg-green-700 text-white">
                <tr>
                    <th class="px-3 py-2">ID</th>
                    <th class="px-3 py-2">Ø§Ù„Ø§Ø³Ù…</th>
                    <th class="px-3 py-2">Ø§Ù„ØµÙ</th>
                    <th class="px-3 py-2">Ø§Ù„ÙØµÙ„</th>
                    <th class="px-3 py-2">Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                    <th class="px-3 py-2">Ø§Ù„ÙˆÙ‚Øª</th>
                    <th class="px-3 py-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th class="px-3 py-2">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Ø§Ù„ØºÙŠØ§Ø¨ -->
<div id="section-absent" class="section hidden">
    <div class="moe-card overflow-x-auto">
        <table class="min-w-full text-sm" id="absentTable">
            <thead class="bg-red-600 text-white">
                <tr>
                    <th class="px-3 py-2">ID</th>
                    <th class="px-3 py-2">Ø§Ù„Ø§Ø³Ù…</th>
                    <th class="px-3 py-2">Ø§Ù„ØµÙ</th>
                    <th class="px-3 py-2">Ø§Ù„ÙØµÙ„</th>
                    <th class="px-3 py-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button onclick="sendAllAbsenceSMS()" class="btn-export" style="background:#047857">
            Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºÙŠØ§Ø¨
        </button>

        <button onclick="exportAbsence()" class="btn-export">ØªØµØ¯ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨</button>
    </div>
</div>

<!-- Ø§Ù„Ù…ØªØ£Ø®Ø±ÙˆÙ† -->
<div id="section-late" class="section hidden">
    <div class="moe-card overflow-x-auto">
        <table class="min-w-full text-sm" id="lateTable">
            <thead class="bg-orange-500 text-white">
                <tr>
                    <th class="px-3 py-2">ID</th>
                    <th class="px-3 py-2">Ø§Ù„Ø§Ø³Ù…</th>
                    <th class="px-3 py-2">Ø§Ù„ØµÙ</th>
                    <th class="px-3 py-2">Ø§Ù„ÙØµÙ„</th>
                    <th class="px-3 py-2">Ø§Ù„ÙˆÙ‚Øª</th>
                    <th class="px-3 py-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="exportLate()" class="btn-export">ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†</button>
    </div>
</div>

<!-- Ø§Ù„Ø¨Ø­Ø« -->
<div id="section-search" class="section hidden">
    <h2 class="text-xl font-bold moe-green mb-4">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØºÙŠØ§Ø¨ Ø·Ø§Ù„Ø¨</h2>

    <div class="moe-card p-4 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

            <div>
                <label class="block mb-1 font-semibold">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (ID)</label>
                <input id="searchID" type="text" class="w-full border p-2 rounded" placeholder="Ù…Ø«Ø§Ù„: 1059">
            </div>

            <div>
                <label class="block mb-1 font-semibold">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input id="searchFrom" type="date" class="w-full border p-2 rounded">
            </div>

            <div>
                <label class="block mb-1 font-semibold">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                <input id="searchTo" type="date" class="w-full border p-2 rounded">
            </div>

            <div class="flex items-end">
                <button onclick="searchBetweenDates()" class="moe-btn px-4 py-2 rounded-lg w-full">
                    Ø¨Ø­Ø« Ø¨ÙŠÙ† ØªØ§Ø±ÙŠØ®ÙŠÙ†
                </button>
            </div>

        </div>
    </div>

    <div class="moe-card overflow-x-auto">
        <table class="min-w-full text-sm" id="searchResultTable">
            <thead class="bg-blue-600 text-white">
                <tr align="center">
                    <th class="px-3 py-2">ID</th>
                    <th class="px-3 py-2">Ø§Ù„Ø§Ø³Ù…</th>
                    <th class="px-3 py-2">Ø§Ù„ØµÙ</th>
                    <th class="px-3 py-2">Ø§Ù„ÙØµÙ„</th>
                    <th class="px-3 py-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th class="px-3 py-2">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Ù‚Ø³Ù… Ø¥Ù†Ø´Ø§Ø¡ QR -->
<div id="section-excel" class="section hidden">
    <div class="moe-card mb-4">
        <h2 class="text-xl font-bold moe-green mb-3">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Excel</h2>
        <input type="file" id="excelFile" class="mb-3" />
        <button id="btnImportExcel" class="moe-btn px-4 py-2 rounded-lg">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
        <p id="excelStatus" class="mt-2 text-sm text-gray-600"></p>
    </div>

    <div class="moe-card" id="studentsContainer">
        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨Ø§Ù„Ø·Ù„Ø§Ø¨ + QR -->
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ SMS -->
<div id="smsModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
  <div class="bg-white rounded-xl p-6 max-w-md w-full">
    <h3 class="text-lg font-bold mb-3 moe-green">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© SMS</h3>
    <p id="smsTargetLabel" class="mb-3 text-sm text-gray-700"></p>
    <p class="text-xs text-gray-500 mb-4">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØºÙŠØ§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeSMSModal()" class="px-3 py-1 rounded bg-gray-200 text-sm">Ø¥Ù„ØºØ§Ø¡</button>
      <button onclick="sendAbsenceSMS(smsTarget)" class="px-3 py-1 rounded bg-green-600 text-white text-sm">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
// ======================= Firebase config =======================
const firebaseConfig = {
  apiKey: "AIzaSyCtzKF6tPdNF9NP34xbz0VNALLU_pW5Tkw",
  authDomain: "attendancesystem-d46ba.firebaseapp.com",
  databaseURL: "https://attendancesystem-d46ba-default-rtdb.firebaseio.com/",
  projectId: "attendancesystem-d46ba",
  storageBucket: "attendancesystem-d46ba.firebasestorage.app",
  messagingSenderId: "472598700266",
  appId: "1:472598700266:web:de916774d90fbe518cb793",
  measurementId: "G-Z6YXDGFHRY"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ======================= Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® =======================
document.getElementById("todayLabel").textContent =
  new Date().toLocaleDateString("ar-SA");

// ======================= Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =======================
let students = [];
let attendance = [];
let lastAbsent = [];
let scanner = null;
let smsTarget = null;

// ======================= Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙŠØ¯ÙˆÙŠ =======================
let START_PRESENT = "06:00";
let END_PRESENT = "07:30";
let END_LATE = "08:00";

document.getElementById("StartPresent").addEventListener("change", e => {
    START_PRESENT = e.target.value;
});

document.getElementById("EndPresent").addEventListener("change", e => {
    END_PRESENT = e.target.value;
});

document.getElementById("EndLate").addEventListener("change", e => {
    END_LATE = e.target.value;
});

// ======================= Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ =======================
function getAttendanceStatus(timeStr) {
    if (!timeStr) return "ØºØ§Ø¦Ø¨";

    const [h, m] = timeStr.replace("Ù…","").replace("Øµ","").split(":").map(Number);
    const studentMin = h * 60 + m;

    const [sH, sM] = START_PRESENT.split(":").map(Number);
    const startMin = sH * 60 + sM;

    const [eH, eM] = END_PRESENT.split(":").map(Number);
    const endPresentMin = eH * 60 + eM;

    const [lH, lM] = END_LATE.split(":").map(Number);
    const endLateMin = lH * 60 + lM;

    if (studentMin < startMin) return "ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨";
    if (studentMin <= endPresentMin) return "Ø­Ø§Ø¶Ø±";
    if (studentMin <= endLateMin) return "Ù…ØªØ£Ø®Ø±";
    return "ØºØ§Ø¦Ø¨";
}

// ======================= Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ§Ø¨Ø§Øª =======================
document.querySelectorAll(".tab-btn").forEach((btn) => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".section").forEach((s) => s.classList.add("hidden"));
    document.getElementById(btn.dataset.target).classList.remove("hidden");

    document.querySelectorAll(".tab-btn").forEach((b) =>
      b.classList.remove("moe-tab-active")
    );
    btn.classList.add("moe-tab-active");

    const today = new Date().toISOString().split("T")[0];

    if (btn.dataset.target === "section-scan") {
      setTimeout(() => startScanner(), 500);
    }
    if (btn.dataset.target === "section-attendance") {
      loadAttendanceFromFirebase(today, () => renderAttendance());
    }
    if (btn.dataset.target === "section-absent") {
      loadAttendanceFromFirebase(today, () => renderAbsent());
    }
    if (btn.dataset.target === "section-late") {
      loadAttendanceFromFirebase(today, () => renderLate());
    }
    if (btn.dataset.target === "section-admin") {
      loadAttendanceFromFirebase(today, () => loadAdminDashboard());
    }
  });
});

// ======================= Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± =======================
function openAdminSection() {
  document.querySelectorAll(".section").forEach(sec => sec.classList.add("hidden"));
  document.getElementById("section-admin").classList.remove("hidden");
  const today = new Date().toISOString().split("T")[0];
  setTimeout(() => {
    loadAttendanceFromFirebase(today, () => loadAdminDashboard());
  }, 200);
}

// ======================= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Firebase =======================
function loadAttendanceFromFirebase(date, callback) {
  const ref = db.ref("attendance/" + date);
  ref.once("value").then(snapshot => {
    const data = snapshot.val();
    attendance = [];
    if (data) {
      Object.keys(data).forEach(id => {
        const r = data[id];
        attendance.push({
          ID: String(r.id || id),
          id: r.id || id,
          name: r.name || "",
          grade: r.grade || "",
          class: r.class || "",
          parentMobile: r.parentMobile || "",
          time: r.time || "",
          date: r.date || date,
          status: getAttendanceStatus(r.time)
        });
      });
    }
    updateStats();
    if (typeof callback === "function") callback();
  });
}

// ======================= ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª =======================
function updateStats() {
  const total = students.length;
  const present = attendance.filter(a => getAttendanceStatus(a.time) === "Ø­Ø§Ø¶Ø±").length;
  const late = attendance.filter(a => getAttendanceStatus(a.time) === "Ù…ØªØ£Ø®Ø±").length;
  const absent = total - present - late;

  const rate = total > 0 ? Math.round((present / total) * 100) : 0;

  document.getElementById("adminTotalStudents").textContent = total;
  document.getElementById("adminPresent").textContent = present;
  document.getElementById("adminLate").textContent = late;
  document.getElementById("adminAbsent").textContent = absent;
  document.getElementById("adminRate").textContent = rate + "%";

  drawCharts(absent, late);
}

// ======================= Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© =======================
let dailyAbsenceChart, dailyLateChart, gradeAbsenceChart;

function drawCharts(absentCount, lateCount) {
  const ctx1 = document.getElementById("dailyAbsenceChart").getContext("2d");
  const ctx2 = document.getElementById("dailyLateChart").getContext("2d");
  const ctx3 = document.getElementById("gradeAbsenceChart").getContext("2d");

  if (dailyAbsenceChart) dailyAbsenceChart.destroy();
  if (dailyLateChart) dailyLateChart.destroy();
  if (gradeAbsenceChart) gradeAbsenceChart.destroy();

  dailyAbsenceChart = new Chart(ctx1, {
    type: "bar",
    data: {
      labels: ["Ø§Ù„ÙŠÙˆÙ…"],
      datasets: [{
        label: "Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨",
        data: [absentCount],
        backgroundColor: "#ef4444"
      }]
    }
  });

  dailyLateChart = new Chart(ctx2, {
    type: "bar",
    data: {
      labels: ["Ø§Ù„ÙŠÙˆÙ…"],
      datasets: [{
        label: "Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†",
        data: [lateCount],
        backgroundColor: "#f97316"
      }]
    }
  });

  const gradeMap = {};
  students.forEach(s => {
    gradeMap[s.grade] = gradeMap[s.grade] || { total: 0, absent: 0 };
    gradeMap[s.grade].total++;
  });

  lastAbsent.forEach(a => {
    if (!gradeMap[a.grade]) gradeMap[a.grade] = { total: 0, absent: 0 };
    gradeMap[a.grade].absent++;
  });

  const labels = Object.keys(gradeMap);
  const dataAbs = labels.map(g => gradeMap[g].absent);

  gradeAbsenceChart = new Chart(ctx3, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "ØºÙŠØ§Ø¨ Ø­Ø³Ø¨ Ø§Ù„ØµÙ",
        data: dataAbs,
        backgroundColor: "#3b82f6"
      }]
    }
  });
}

function loadAdminDashboard() {
  updateStats();
}

// ======================= Ø¬Ù„Ø¨ Ø±ØµÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =======================
async function loadSMSBalance() {
    try {
        const res = await fetch("https://app.mobile.net.sa/api/v1/get-balance", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer XRGdRQaYcesQbFy6rtzS2pOGARSHXBG7yAqC4rDr"
            }
        });

        const data = await res.json().catch(() => null);
		console.log("BALANCE RESPONSE:", data);

        if (!data || data.balance === undefined) {
            document.getElementById("smsBalance").textContent = "ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯";
            return;
        }

        document.getElementById("smsBalance").textContent =
            "Ø±ØµÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: " + data.balance;

    } catch (e) {
        document.getElementById("smsBalance").textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
    }
}
</script>
<script>
// ======================= Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¶ÙˆØ± =======================
function renderAttendance() {
  const tbody = document.querySelector("#attendanceTable tbody");
  tbody.innerHTML = "";

  if (attendance.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8" class="py-3 text-center text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ± Ù…Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</td></tr>`;
    return;
  }

  attendance.forEach(r => {
    const status = getAttendanceStatus(r.time);

    tbody.innerHTML += `
      <tr class="border-b">
        <td class="px-3 py-2">${r.ID}</td>
        <td class="px-3 py-2">${r.name}</td>
        <td class="px-3 py-2">${r.grade}</td>
        <td class="px-3 py-2">${r.class}</td>
        <td class="px-3 py-2">${r.parentMobile}</td>
        <td class="px-3 py-2">${r.time}</td>
        <td class="px-3 py-2">${r.date}</td>
        <td class="px-3 py-2">${status}</td>
      </tr>
    `;
  });
}

// ======================= Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ† =======================
function renderLate() {
  const tbody = document.querySelector("#lateTable tbody");
  tbody.innerHTML = "";

  const lateList = attendance.filter(r => getAttendanceStatus(r.time) === "Ù…ØªØ£Ø®Ø±");

  if (lateList.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="py-3 text-center text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ£Ø®Ø±ÙˆÙ† Ø§Ù„ÙŠÙˆÙ…</td></tr>`;
    return;
  }

  lateList.forEach(r => {
    tbody.innerHTML += `
      <tr class="border-b">
        <td class="px-3 py-2">${r.ID}</td>
        <td class="px-3 py-2">${r.name}</td>
        <td class="px-3 py-2">${r.grade}</td>
        <td class="px-3 py-2">${r.class}</td>
        <td class="px-3 py-2">${r.time}</td>
        <td class="px-3 py-2">${r.date}</td>
      </tr>
    `;
  });
}

// ======================= Ø¹Ø±Ø¶ Ø§Ù„ØºÙŠØ§Ø¨ =======================
function renderAbsent() {
  const tbody = document.querySelector("#absentTable tbody");
  tbody.innerHTML = "";

  if (students.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="py-3 text-center text-gray-500">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹</td></tr>`;
    lastAbsent = [];
    updateStats();
    return;
  }

  const today = new Date().toISOString().split("T")[0];
  const presentIDs = new Set(attendance.map(a => a.ID));

  const absent = students.filter(s => {
    if (presentIDs.has(s.ID)) {
        const rec = attendance.find(a => a.ID === s.ID);
        return getAttendanceStatus(rec.time) === "ØºØ§Ø¦Ø¨";
    }
    return true;
  });

  lastAbsent = absent;

  if (absent.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="py-3 text-center text-green-600">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</td></tr>`;
  } else {
    absent.forEach(s => {
      tbody.innerHTML += `
        <tr class="border-b">
          <td class="px-3 py-2">${s.ID}</td>
          <td class="px-3 py-2">${s.name}</td>
          <td class="px-3 py-2">${s.grade}</td>
          <td class="px-3 py-2">${s.class}</td>
          <td class="px-3 py-2">${today}</td>
        </tr>
      `;
    });
  }

  updateStats();
}

// ======================= Ø§Ù„Ø¨Ø­Ø« Ø¨ÙŠÙ† ØªØ§Ø±ÙŠØ®ÙŠÙ† =======================
async function searchBetweenDates() {
  const id = document.getElementById("searchID").value.trim();
  const from = document.getElementById("searchFrom").value;
  const to = document.getElementById("searchTo").value;

  const tbody = document.querySelector("#searchResultTable tbody");
  tbody.innerHTML = "";

  if (!id || !from || !to) {
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");
    return;
  }

  const fromDate = new Date(from);
  const toDate = new Date(to);

  const stu = students.find(s => s.ID == id);
  if (!stu) {
    alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨");
    return;
  }

  const results = [];

  for (let d = new Date(fromDate); d <= toDate; d.setDate(d.getDate() + 1)) {
    const ds = d.toISOString().split("T")[0];
    const ref = db.ref("attendance/" + ds + "/" + id);
    const snap = await ref.once("value");

    if (!snap.exists()) {
      results.push({
        ID: id,
        name: stu.name,
        grade: stu.grade,
        class: stu.class,
        date: ds,
        status: "ØºØ§Ø¦Ø¨"
      });
    }
  }

  if (results.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="py-3 text-center text-red-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª ØºÙŠØ§Ø¨ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>`;
    return;
  }

  results.forEach(r => {
    tbody.innerHTML += `
      <tr align="center" class="border-b">
        <td>${r.ID}</td>
        <td>${r.name}</td>
        <td>${r.grade}</td>
        <td>${r.class}</td>
        <td>${r.date}</td>
        <td>${r.status}</td>
      </tr>
    `;
  });
}

// ======================= Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Excel =======================
document.getElementById("btnImportExcel").onclick = () => {
  const file = document.getElementById("excelFile").files[0];
  if (!file) return alert("Ø§Ø®ØªØ± Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹");

  const reader = new FileReader();
  reader.onload = (e) => {
    const wb = XLSX.read(e.target.result, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);

    students = json.map((r) => ({
      ID: String(r.ID || "").trim(),
      name: r.Name || "",
      grade: r.Grade || "",
      class: r.Class || "",
      parentMobile: String(r.ParentMobile || "").trim(),
      token: Math.random().toString(36).substring(2, 10)
    }));

    document.getElementById("excelStatus").textContent =
      "ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ " + students.length + " Ø·Ø§Ù„Ø¨.";

    renderStudents();
    updateStats();
  };

  reader.readAsArrayBuffer(file);
};

// ======================= Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨ + QR =======================
function renderStudents() {
  let html = `
<table class="min-w-full text-sm">
<thead class="bg-green-700 text-white">
<tr>
<th class="px-3 py-2">ID</th>
<th class="px-3 py-2">Ø§Ù„Ø§Ø³Ù…</th>
<th class="px-3 py-2">Ø§Ù„ØµÙ</th>
<th class="px-3 py-2">Ø§Ù„ÙØµÙ„</th>
<th class="px-3 py-2">Ø§Ù„Ø¬ÙˆØ§Ù„</th>
<th class="px-3 py-2">QR</th>
<th class="px-3 py-2">SMS</th>
</tr>
</thead>
<tbody>
`;

  students.forEach((s) => {
    const qrData = JSON.stringify({
      ID: s.ID,
      TOKEN: s.token,
      NAME: s.name,
      GRADE: s.grade,
      CLASS: s.class,
      parentMobile: s.parentMobile
    });

    const qrUrl =
      "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" +
      encodeURIComponent(qrData);

    html += `
<tr class="border-b">
<td class="px-3 py-2">${s.ID}</td>
<td class="px-3 py-2">${s.name}</td>
<td class="px-3 py-2">${s.grade}</td>
<td class="px-3 py-2">${s.class}</td>
<td class="px-3 py-2">${s.parentMobile}</td>
<td class="px-3 py-2"><img src="${qrUrl}" class="w-16 mx-auto"/></td>
<td class="px-3 py-2">
<button onclick="openSMSModal('${s.ID}')" class="moe-btn px-3 py-1 rounded text-xs">SMS</button>
</td>
</tr>
`;
  });

  html += "</tbody></table>";
  document.getElementById("studentsContainer").innerHTML = html;
}

// ======================= SMS =======================
function openSMSModal(id) {
  smsTarget = students.find((s) => s.ID == id) || attendance.find(a => a.ID == id);
  if (!smsTarget) {
    alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨");
    return;
  }
  document.getElementById("smsTargetLabel").textContent =
    `Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ ${smsTarget.name} (${smsTarget.parentMobile})`;
  document.getElementById("smsModal").classList.remove("hidden");
}

function closeSMSModal() {
  document.getElementById("smsModal").classList.add("hidden");
}

function normalizeMobile(n) {
  n = String(n).replace(/\D/g, "");
  if (n.startsWith("966")) return n;
  if (n.startsWith("05")) return "966" + n.slice(1);
  if (n.startsWith("5")) return "966" + n;
  return n;
}

async function sendAbsenceSMS(student) {
  try {
    const mobile = normalizeMobile(student.parentMobile);
    if (!mobile) {
      console.warn("Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­:", student.parentMobile);
      return;
    }

    const firstName = student.name.split(" ")[0];
    const hijriDate = new Intl.DateTimeFormat("ar-SA-u-ca-islamic", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric"
    }).format(new Date());

    const stamp = new Date().getTime().toString().slice(-4);

    const msg = `Ø§Ø¨Ù†ÙƒÙ… ${firstName} ØºØ§Ø¨ Ø¹Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠÙˆÙ… ${hijriDate} â€“ ${stamp}`;

    const payload = {
      number: mobile,
      senderName: "School1",
      sendAtOption: "NOW",
      messageBody: msg,
    };

    const res = await fetch("https://app.mobile.net.sa/api/v1/send", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer XRGdRQaYcesQbFy6rtzS2pOGARSHXBG7yAqC4rDr",
      },
      body: JSON.stringify(payload),
    });

    const result = await res.json().catch(() => null);

    if (!result || (result.status !== "Success" && result.status !== "success")) {
      alert("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
      return;
    }

    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØºÙŠØ§Ø¨");

  } catch (err) {
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
  }
}

async function sendAllAbsenceSMS() {
  if (!lastAbsent || lastAbsent.length === 0) {
    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ØºØ§Ø¦Ø¨ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…");
    return;
  }

  for (const stu of lastAbsent) {
    await sendAbsenceSMS(stu);
    await new Promise(r => setTimeout(r, 500));
  }

  alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºÙŠØ§Ø¨ Ù„Ø¬Ù…ÙŠØ¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±");
}
</script>
<script>
// ======================= ØªØµØ¯ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ =======================
function exportAbsence() {
  if (!lastAbsent || lastAbsent.length === 0) {
    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ§Ø¨ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");
    return;
  }

  const wsData = [["ID","Ø§Ù„Ø§Ø³Ù…","Ø§Ù„ØµÙ","Ø§Ù„ÙØµÙ„","Ø§Ù„ØªØ§Ø±ÙŠØ®"]];
  const today = new Date().toISOString().split("T")[0];

  lastAbsent.forEach(s => {
    wsData.push([s.ID, s.name, s.grade, s.class, today]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Absence");
  XLSX.writeFile(wb, "absence.xlsx");
}

// ======================= ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ† =======================
function exportLate() {
  const lateList = attendance.filter(r => getAttendanceStatus(r.time) === "Ù…ØªØ£Ø®Ø±");

  if (lateList.length === 0) {
    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ£Ø®Ø±ÙˆÙ† Ù„ØªØµØ¯ÙŠØ±Ù‡Ù…");
    return;
  }

  const wsData = [["ID","Ø§Ù„Ø§Ø³Ù…","Ø§Ù„ØµÙ","Ø§Ù„ÙØµÙ„","Ø§Ù„ÙˆÙ‚Øª","Ø§Ù„ØªØ§Ø±ÙŠØ®"]];

  lateList.forEach(r => {
    wsData.push([r.ID, r.name, r.grade, r.class, r.time, r.date]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Late");
  XLSX.writeFile(wb, "late.xlsx");
}

// ======================= Ù…Ø§Ø³Ø­ QR =======================
function startScanner() {
  document.getElementById("scanMessage").textContent =
    "Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ Ø§Ù„Ù…Ø³Ø­ ÙŠØ¹Ù…Ù„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.";
}

// ======================= Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ =======================
(async () => {

  // ØªØ´ØºÙŠÙ„ Ø¬Ù„Ø¨ Ø±ØµÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  loadSMSBalance();

  const today = new Date().toISOString().split("T")[0];

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Google Sheet (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  try {
    const res = await fetch(
      "https://script.google.com/macros/s/AKfycbw3F5TiR_sP9L3-LdndSbBgQ799SkjST48B5Lhv-bcHFdqVMcLxcf9dmcmybetIWfjNFA/exec?action=getStudents"
    );
    const data = await res.json();

    students = data.map(s => ({
      ID: String(s.ID).trim(),
      name: s.name,
      grade: s.grade,
      class: s.class,
      parentMobile: String(s.parentMobile).trim(),
      token: s.token
    }));
  } catch (e) {
    console.warn("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ø§Ù„Ø´ÙŠØª");
  }

  loadAttendanceFromFirebase(today, () => {
    loadAdminDashboard();
  });

})();
</script>

</div>
</div>

</body>
</html>
