<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام حضور الطلاب - وزارة التعليم</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: "Tajawal", sans-serif;
      background: #f3f6f4;
      direction: rtl;
    }
    .moe-green {
      color: #017c67;
    }
    .moe-btn {
      background-color: #017c67;
      color: white;
    }
    .moe-btn:hover {
      background-color: #026f5d;
    }
    .moe-card {
      background: white;
      border-radius: 16px;
      border: 1px solid #d9e3df;
      padding: 20px;
    }
    .moe-tab-active {
      background-color: #017c67 !important;
      color: white !important;
    }
  </style>
</head>

<body>

  <div class="max-w-6xl mx-auto p-4 md:p-6">

    <div class="moe-card shadow-md">

      <!-- HEADER -->
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
        <div>
          <h1 class="text-3xl font-bold moe-green">نظام حضور الطلاب</h1>
          <p class="text-gray-500 mt-1 text-sm">متوافق مع معايير وزارة التعليم – QR + Google Sheets + SMS</p>
        </div>
        <div class="text-sm text-gray-700">
          <div><strong>التاريخ:</strong> <span id="todayLabel"></span></div>
          <div id="smsBalance" class="mt-1 text-xs font-semibold text-green-700">جاري جلب رصيد الرسائل...</div>
        </div>
      </div>

      <!-- TABS -->
      <div class="grid grid-cols-2 md:grid-cols-6 gap-2 mb-6">
        <button class="tab-btn moe-tab-active py-2 rounded-lg font-semibold" data-target="section-dashboard">لوحة الإحصائيات</button>
        <button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-excel">إنشاء QR</button>
        <button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-scan">مسح QR</button>
        <button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-attendance">سجل الحضور</button>
        <button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-absent">الغياب</button>
        <button class="tab-btn bg-gray-200 py-2 rounded-lg font-semibold" data-target="section-late">المتأخرون</button>
      </div>

      <!-- DASHBOARD -->
      <div id="section-dashboard" class="section">
        <h2 class="text-xl font-bold moe-green mb-4">لوحة الإحصائيات</h2>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">إجمالي الطلاب</p>
            <p id="statTotalStudents" class="text-2xl font-bold moe-green">0</p>
          </div>
          <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">الحاضرون</p>
            <p id="statPresentToday" class="text-2xl font-bold text-green-700">0</p>
          </div>
          <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">المتأخرون</p>
            <p id="statLateToday" class="text-2xl font-bold text-orange-600">0</p>
          </div>
          <div class="moe-card text-center">
            <p class="text-gray-600 text-sm mb-1">الغياب</p>
            <p id="statAbsentToday" class="text-2xl font-bold text-red-600">0</p>
          </div>
        </div>
      </div>

      <!-- QR FROM EXCEL -->
      <div id="section-excel" class="section hidden">
        <h2 class="text-xl font-bold moe-green mb-3">إنشاء QR من ملف Excel</h2>

        <div class="flex flex-col md:flex-row gap-4 items-center mb-3">
          <input id="excelFile" type="file" accept=".xls,.xlsx" class="border rounded px-3 py-2 text-sm bg-gray-50" />
          <button id="btnImportExcel" class="moe-btn px-4 py-2 rounded-lg text-sm font-semibold">استيراد الطلاب</button>
        </div>

        <div id="excelStatus" class="text-sm text-gray-600 mb-3"></div>
        <div id="studentsContainer"></div>
      </div>

      <!-- QR SCANNER -->
      <div id="section-scan" class="section hidden">
        <h2 class="text-xl font-bold moe-green mb-4">مسح QR</h2>
        <div id="reader" class="w-full max-w-md mx-auto border-2 border-green-700 rounded-xl"></div>
        <p id="scanMessage" class="text-center mt-4 text-sm font-bold"></p>
      </div>

      <!-- ATTENDANCE -->
      <div id="section-attendance" class="section hidden">
        <h2 class="text-xl font-bold moe-green mb-4">سجل الحضور</h2>
        <div class="moe-card overflow-x-auto">
          <table class="min-w-full text-sm" id="attendanceTable">
            <thead class="bg-green-700 text-white">
              <tr>
                <th class="px-3 py-2">ID</th>
                <th class="px-3 py-2">الاسم</th>
                <th class="px-3 py-2">الصف</th>
                <th class="px-3 py-2">الفصل</th>
                <th class="px-3 py-2">رقم ولي الأمر</th>
                <th class="px-3 py-2">QR</th>
                <th class="px-3 py-2">SMS</th>
                <th class="px-3 py-2">الوقت</th>
                <th class="px-3 py-2">التاريخ</th>
                <th class="px-3 py-2">الحالة</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ABSENT -->
      <div id="section-absent" class="section hidden">
        <h2 class="text-xl font-bold moe-green mb-4">قائمة الغياب</h2>
        <div class="moe-card overflow-x-auto">
          <table class="min-w-full text-sm" id="absentTable">
            <thead class="bg-red-600 text-white">
              <tr>
                <th class="px-3 py-2">ID</th>
                <th class="px-3 py-2">الاسم</th>
                <th class="px-3 py-2">الصف</th>
                <th class="px-3 py-2">الفصل</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- LATE -->
      <div id="section-late" class="section hidden">
        <h2 class="text-xl font-bold text-orange-600 mb-4">قائمة المتأخرين</h2>
        <div class="moe-card overflow-x-auto">
          <table class="min-w-full text-sm" id="lateTable">
            <thead class="bg-orange-500 text-white">
              <tr>
                <th class="px-3 py-2">ID</th>
                <th class="px-3 py-2">الاسم</th>
                <th class="px-3 py-2">الصف</th>
                <th class="px-3 py-2">الفصل</th>
                <th class="px-3 py-2">الوقت</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- SMS POPUP -->
  <div id="smsModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white w-80 p-5 rounded-2xl shadow-xl">
      <h3 class="text-lg font-bold moe-green mb-3 text-center">إرسال رسالة نصية</h3>
      <p class="text-sm text-gray-600 mb-2"><span id="smsTargetLabel"></span></p>
      <textarea id="smsMessage" class="w-full border rounded-lg p-2 text-sm" rows="4" placeholder="اكتب الرسالة هنا..."></textarea>

      <div class="flex justify-between mt-4">
        <button onclick="closeSMSModal()" class="bg-gray-300 px-4 py-2 rounded-lg text-sm font-semibold">إلغاء</button>
        <button onclick="confirmSendSMS()" class="moe-btn px-4 py-2 rounded-lg text-sm font-semibold">إرسال</button>
      </div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>

/* =============================
    إعدادات عامة
============================= */
const API_URL = "https://script.google.com/macros/s/AKfycbx4PKVybf33NP9-LVhSY1l1Mz1FoSCOY58v88YmzkJBmXdmgSvUoyTX-Q2XlVLWlavGEQ/exec";

const SMS_API_URL = "https://app.mobile.net.sa/api/v1/send";
const SMS_BALANCE_URL = "https://app.mobile.net.sa/api/v1/get-balance";
const SMS_API_KEY = "XRGdRQaYcesQbFy6rtzS2pOGARSHXBG7yAqC4rDr";
const SMS_SENDER_NAME = "School1";

let students = [];
let smsTarget = null;
let scanner = null;

/* =============================
   التبويبات
============================= */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    // إخفاء كل الأقسام
    document.querySelectorAll(".section").forEach(sec => sec.classList.add("hidden"));

    // إظهار القسم المطلوب
    document.getElementById(btn.dataset.target).classList.remove("hidden");

    // تفعيل الزر
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("moe-tab-active"));
    btn.classList.add("moe-tab-active");

    // تشغيل الكاميرا عند قسم المسح
    if (btn.dataset.target === "section-scan") {
      setTimeout(() => startScanner(), 500);
    }
  });
});

/* =============================
   استيراد الطلاب من Excel
============================= */
document.getElementById("btnImportExcel").addEventListener("click", () => {
  const file = document.getElementById("excelFile").files[0];
  const status = document.getElementById("excelStatus");

  if (!file) return alert("اختر ملف Excel أولاً");

  const reader = new FileReader();
  reader.onload = e => {
    const workbook = XLSX.read(e.target.result, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);

    students = json.map(r => ({
      ID: r.ID,
      name: r.Name,
      grade: r.Grade,
      class: r.Class,
      parentMobile: r.ParentMobile || ""
    }));

    status.textContent = "تم استيراد " + students.length + " طالب.";

    renderStudents();

    // حفظ الطلاب
    students.forEach(s => saveStudent(s));
  };

  reader.readAsArrayBuffer(file);
});

/* حفظ طالب في Google Sheet */
function saveStudent(s) {
  const form = new URLSearchParams();
  form.append("action", "addStudent");
  form.append("ID", s.ID);
  form.append("name", s.name);
  form.append("grade", s.grade);
  form.append("class", s.class);
  form.append("parentMobile", s.parentMobile);
  form.append("qr", "");

  fetch(API_URL, { method: "POST", body: form });
}

/* =============================
   عرض الطلاب مع QR و SMS
============================= */
function renderStudents() {
  const container = document.getElementById("studentsContainer");
  container.innerHTML = "";

  let html = `
    <table class='min-w-full text-sm'>
      <thead class='bg-green-700 text-white'>
        <tr>
          <th class='px-3 py-2'>ID</th>
          <th class='px-3 py-2'>الاسم</th>
          <th class='px-3 py-2'>الصف</th>
          <th class='px-3 py-2'>الفصل</th>
          <th class='px-3 py-2'>الجوال</th>
          <th class='px-3 py-2'>QR</th>
          <th class='px-3 py-2'>SMS</th>
        </tr>
      </thead>
      <tbody>
  `;

  students.forEach(s => {
    const qrData = `ID=${s.ID};NAME=${s.name};GRADE=${s.grade};CLASS=${s.class};PARENT=${s.parentMobile}`;
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(qrData)}&size=150x150`;

    html += `
      <tr class='border-b'>
        <td class='px-3 py-2'>${s.ID}</td>
        <td class='px-3 py-2'>${s.name}</td>
        <td class='px-3 py-2'>${s.grade}</td>
        <td class='px-3 py-2'>${s.class}</td>
        <td class='px-3 py-2'>${s.parentMobile}</td>
        <td class='px-3 py-2'><img src='${qrUrl}' class='w-16 mx-auto'></td>
        <td class='px-3 py-2'>
          <button onclick="openSMSModal('${s.ID}')" class='moe-btn px-3 py-1 rounded text-xs'>SMS</button>
        </td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

/* =============================
   نافذة SMS
============================= */
function openSMSModal(id) {
  smsTarget = students.find(s => s.ID == id);
  document.getElementById("smsTargetLabel").textContent =
    `إرسال رسالة إلى ولي أمر الطالب: ${smsTarget.name} (${smsTarget.parentMobile})`;
  document.getElementById("smsMessage").value = "";
  document.getElementById("smsModal").classList.remove("hidden");
}

function closeSMSModal() {
  document.getElementById("smsModal").classList.add("hidden");
}

/* تنسيق رقم الجوال */
function normalizeMobile(m) {
  if (!m) return "";
  m = m.toString().replace(/\D/g, "");
  if (m.startsWith("966")) return m;
  if (m.startsWith("05")) return "966" + m.slice(1);
  if (m.startsWith("5")) return "966" + m;
  return m;
}

/* إرسال SMS */
async function confirmSendSMS() {
  const msg = document.getElementById("smsMessage").value.trim();
  if (!msg) return alert("اكتب نص الرسالة");

  const mobile = normalizeMobile(smsTarget.parentMobile);
  if (!mobile) return alert("رقم ولي الأمر غير صالح");

  const payload = {
    number: mobile,
    senderName: SMS_SENDER_NAME,
    sendAtOption: "NOW",
    messageBody: msg
  };

  await fetch(SMS_API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + SMS_API_KEY
    },
    body: JSON.stringify(payload)
  });

  alert("تم إرسال الرسالة بنجاح");
  closeSMSModal();
}

/* =============================
   تشغيل ماسح QR
============================= */
function startScanner() {
  if (scanner) return;

  scanner = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cams => {
    if (!cams.length) return alert("لا يوجد كاميرا");

    scanner.start(
      cams[0].id,
      { fps: 10, qrbox: 250 },
      qr => handleQR(qr)
    );
  });
}

function handleQR(text) {
  document.getElementById("scanMessage").textContent = "تم المسح ✔";

  const parts = text.split(";");
  let data = {};

  parts.forEach(p => {
    const [k, v] = p.split("=");
    data[k] = v;
  });

  sendAttendance(data);
}

/* =============================
   إرسال حضور الطالب
============================= */
function sendAttendance(stu) {
  const form = new URLSearchParams();
  form.append("action", "recordAttendance");
  form.append("ID", stu.ID);
  form.append("name", stu.NAME);
  form.append("grade", stu.GRADE);
  form.append("class", stu.CLASS);
  form.append("ParentMobile", stu.PARENT);
  form.append("time", new Date().toLocaleTimeString());
  form.append("date", new Date().toLocaleDateString("ar-SA"));

  fetch(API_URL, { method: "POST", body: form });

  alert("تم تسجيل حضور الطالب");
}

/* =============================
   جلب رصيد الرسائل
============================= */
async function getBalance() {
  const res = await fetch(SMS_BALANCE_URL, {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + SMS_API_KEY
    }
  });

  const txt = await res.text();
  let balance = "غير متاح";

  try {
    const json = JSON.parse(txt);
    balance = json.data.balance;
  } catch {}

  document.getElementById("smsBalance").textContent = "رصيد الرسائل: " + balance;
}

getBalance();

</script>

</body>
</html>
